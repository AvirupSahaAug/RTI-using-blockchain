<%- include('../../partials/header') %>
    <h2>Client Dashboard</h2>
    
    <div class="card">
        <h3>Create New RTI Request</h3>
        <form id="requestForm" action="/client/request" enctype="multipart/form-data">
            <div class="form-group">
                <label>Description:</label>
                <textarea name="description" required placeholder="Describe your RTI request"></textarea>
            </div>
            
            <div class="form-group">
                <label>Document (optional):</label>
                <input type="file" name="document">
            </div>
            
            <button type="button" onclick="submitRequest()" class="btn">Submit Request</button>
        </form>
    </div>
    
    <div class="card">
        <h3>My RTI Requests</h3>
        <% if (requests && requests.length > 0) { %>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 0.5rem;">ID</th>
                        <th style="border: 1px solid #ddd; padding: 0.5rem;">Description</th>
                        <th style="border: 1px solid #ddd; padding: 0.5rem;">Status</th>
                        <th style="border: 1px solid #ddd; padding: 0.5rem;">Created</th>
                        <th style="border: 1px solid #ddd; padding: 0.5rem;">Assigned</th>
                        <th style="border: 1px solid #ddd; padding: 0.5rem;">Responded</th>
                        <th style="border: 1px solid #ddd; padding: 0.5rem;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% requests.forEach(request => { %>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 0.5rem;"><%= request.id %></td>
                        <td style="border: 1px solid #ddd; padding: 0.5rem;"><%= request.description %></td>
                        <td style="border: 1px solid #ddd; padding: 0.5rem;">
                            <%= 
                                request.status === '0' ? 'Pending' :
                                request.status === '1' ? 'Assigned' :
                                request.status === '2' ? 'Responded' : 'Completed'
                            %>
                        </td>
                        <td style="border: 1px solid #ddd; padding: 0.5rem;"><%= request.createdAt ? new Date(Number(request.createdAt)).toLocaleString() : '—' %></td>
                        <td style="border: 1px solid #ddd; padding: 0.5rem;"><%= request.assignedAt ? new Date(Number(request.assignedAt)).toLocaleString() : '—' %></td>
                        <td style="border: 1px solid #ddd; padding: 0.5rem;"><%= request.respondedAt ? new Date(Number(request.respondedAt)).toLocaleString() : '—' %></td>
                        <td style="border: 1px solid #ddd; padding: 0.5rem;">
                            <% if (request.requestHash) { %>
                                <button onclick="downloadFile('<%= request.requestHash %>', '<%= (request.requestFilename || 'request') %>')" class="btn">Download Request</button>
                            <% } %>
                            <% if (request.responseHash) { %>
                                <button onclick="downloadFile('<%= request.responseHash %>', '<%= (request.responseFilename || 'response') %>')" class="btn">Download Response</button>
                                <% const existingComplaint = (complaints || []).find(c => String(c.requestId) === String(request.id)); %>
                                <% if (!existingComplaint) { %>
                                    <div style="margin-top: 0.5rem;">
                                        <form id="complaintForm-<%= request.id %>">
                                            <input type="hidden" name="requestId" value="<%= request.id %>">
                                            <div class="form-group">
                                                <label>Raise Complaint:</label>
                                                <input type="text" name="text" placeholder="Describe the issue" required style="width: 100%;">
                                            </div>
                                            <button type="button" class="btn" onclick="submitComplaint(<%= request.id %>)">Submit Complaint</button>
                                        </form>
                                    </div>
                                <% } else { %>
                                    <div style="margin-top: 0.5rem; border-top: 1px dashed #ddd; padding-top: 0.5rem;">
                                        <p><strong>Complaint ID:</strong> <%= existingComplaint.id %></p>
                                        <p><strong>Complaint:</strong> <%= existingComplaint.text %></p>
                                        <p><strong>Resolution:</strong> <%= existingComplaint.resolutionHash ? 'Uploaded' : '—' %></p>
                                        <% if (existingComplaint.resolutionHash) { %>
                                            <button class="btn" onclick="downloadFile('<%= existingComplaint.resolutionHash %>', '<%= (existingComplaint.resolutionFilename || 'resolution') %>')">Download Resolution</button>
                                        <% } %>
                                        <% if (!existingComplaint.resolvedByUser) { %>
                                            <button type="button" class="btn" onclick="markComplaintResolved('<%= existingComplaint.id %>')">Mark Resolved</button>
                                        <% } %>
                                    </div>
                                <% } %>
                            <% } %>
                        </td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>
        <% } else { %>
            <p>No requests found.</p>
        <% } %>
    </div>
    
    <script>
        async function submitRequest() {
            const form = document.getElementById('requestForm');
            await submitFormWithFile(form, function() {
                form.reset();
                location.reload();
            });
        }

        async function submitComplaint(requestId) {
            const form = document.getElementById('complaintForm-' + requestId);
            const payload = {
                requestId: form.querySelector('input[name="requestId"]').value,
                text: form.querySelector('input[name="text"]').value
            };
            const res = await fetch('/client/complaint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            if (result.success) {
                alert('Complaint submitted (ID: ' + result.complaintId + ')');
                location.reload();
            } else {
                alert('Error: ' + (result.error || 'Failed'));
            }
        }

        async function markComplaintResolved(complaintId) {
            const res = await fetch('/client/complaints/mark-resolved', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ complaintId })
            });
            const result = await res.json();
            if (result.success) {
                alert('Marked as resolved');
                location.reload();
            } else {
                alert('Error: ' + (result.error || 'Failed'));
            }
        }
    </script>
<%- include('../../partials/footer') %>