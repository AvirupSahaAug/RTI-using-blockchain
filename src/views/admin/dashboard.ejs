<%- include('../../partials/header') %>
    <h2>Admin Dashboard</h2>
    
    
    
    <div class="card">
        <h3>Pending Requests</h3>
        <% if (pendingRequests && pendingRequests.length > 0) { %>
            <% pendingRequests.forEach(request => { %>
            <div style="border: 1px solid #ddd; padding: 1rem; margin: 0.5rem 0;">
                <p><strong>Request ID:</strong> <%= request.id %></p>
                <p><strong>Client ID:</strong> <%= request.clientId %></p>
                <p><strong>Description:</strong> <%= request.description %></p>
                <p><strong>Created:</strong> <%= request.createdAt ? new Date(Number(request.createdAt)).toLocaleString() : '—' %></p>
                <% if (request.requestHash) { %>
                    <button onclick="downloadFile('<%= request.requestHash %>', '<%= (request.requestFilename || 'request') %>')" class="btn">Download Request</button>
                <% } %>
                
                <form id="assignForm-<%= request.id %>" style="margin-top: 1rem;">
                    <input type="hidden" name="requestId" value="<%= request.id %>">
                    <div class="form-group">
                        <label>Assign to Officer:</label>
                        <select name="officerUserId" required>
                            <option value="">Select officer</option>
                            <% (officerUsers || []).forEach(o => { %>
                                <option value="<%= o.id %>"><%= o.name %> (ID: <%= o.id %>)</option>
                            <% }) %>
                        </select>
                    </div>
                    <button type="button" onclick="assignRequest(<%= request.id %>)" class="btn">Assign</button>
                </form>
            </div>
            <% }); %>
        <% } else { %>
            <p>No pending requests.</p>
        <% } %>
    </div>
    
    <div class="card">
        <h3>Assigned Requests</h3>
        <% if (assignedRequests && assignedRequests.length > 0) { %>
            <% assignedRequests.forEach(request => { %>
            <div style="border: 1px solid #ddd; padding: 1rem; margin: 0.5rem 0;">
                <p><strong>Request ID:</strong> <%= request.id %></p>
                <p><strong>Officer ID:</strong> <%= request.assignedOfficerUserId || '—' %></p>
                <p><strong>Description:</strong> <%= request.description %></p>
                <p><strong>Assigned:</strong> <%= request.assignedAt ? new Date(Number(request.assignedAt)).toLocaleString() : '—' %></p>
            </div>
            <% }); %>
        <% } else { %>
            <p>No assigned requests.</p>
        <% } %>
    </div>
    
    <div class="card">
        <h3>Overdue (Assigned > 5 minutes without response)</h3>
        <% if (overdueAssignedRequests && overdueAssignedRequests.length > 0) { %>
            <% overdueAssignedRequests.forEach(request => { %>
            <div style="border: 1px solid #f39c12; padding: 1rem; margin: 0.5rem 0; background: #fffaf2;">
                <p><strong>Request ID:</strong> <%= request.id %></p>
                <p><strong>Officer ID:</strong> <%= request.assignedOfficerUserId || '—' %></p>
                <p><strong>Description:</strong> <%= request.description %></p>
                <p><strong>Assigned:</strong> <%= request.assignedAt ? new Date(Number(request.assignedAt)).toLocaleString() : '—' %></p>
                <p><strong>Status:</strong> Overdue</p>
            </div>
            <% }); %>
        <% } else { %>
            <p>No overdue items.</p>
        <% } %>
    </div>

    <div class="card">
        <h3>Responded Requests</h3>
        <% if (respondedRequests && respondedRequests.length > 0) { %>
            <% respondedRequests.forEach(request => { %>
            <div style="border: 1px solid #ddd; padding: 1rem; margin: 0.5rem 0;">
                <p><strong>Request ID:</strong> <%= request.id %></p>
                <p><strong>Client ID:</strong> <%= request.clientId %></p>
                <p><strong>Officer ID:</strong> <%= request.assignedOfficerUserId %></p>
                <p><strong>Responded:</strong> <%= request.respondedAt ? new Date(Number(request.respondedAt)).toLocaleString() : '—' %></p>
                <% if (request.responseHash) { %>
                    <button onclick="downloadFile('<%= request.responseHash %>', '<%= (request.responseFilename || 'response') %>')" class="btn">Download Response</button>
                <% } %>
            </div>
            <% }); %>
        <% } else { %>
            <p>No responded requests.</p>
        <% } %>
    </div>

    <div class="card">
        <h3>Active Complaints</h3>
        <% if (complaints && complaints.length > 0) { %>
            <% complaints.forEach(c => { %>
            <div style="border: 1px solid #ddd; padding: 1rem; margin: 0.5rem 0;">
                <p><strong>Complaint ID:</strong> <%= c.id %></p>
                <p><strong>Request ID:</strong> <%= c.requestId %></p>
                <p><strong>Client ID:</strong> <%= c.clientUserId %></p>
                <p><strong>Officer ID:</strong> <%= c.officerUserId %></p>
                <p><strong>Complaint:</strong> <%= c.text %></p>
                <p><strong>Resolution:</strong> <%= c.resolutionHash ? 'Uploaded' : '—' %></p>
                <% if (c.resolutionHash) { %>
                    <button onclick="downloadFile('<%= c.resolutionHash %>', '<%= (c.resolutionFilename || 'resolution') %>')" class="btn">Download Resolution</button>
                <% } %>
                <% const req = (respondedRequests || []).find(r => String(r.id) === String(c.requestId)); %>
                <% if (req && req.requestHash) { %>
                    <button onclick="downloadFile('<%= req.requestHash %>', '<%= (req.requestFilename || 'request') %>')" class="btn">Download Request</button>
                <% } %>
                <% if (req && req.responseHash) { %>
                    <button onclick="downloadFile('<%= req.responseHash %>', '<%= (req.responseFilename || 'response') %>')" class="btn">Download Response</button>
                <% } %>
                <div style="margin-top: 0.5rem;">
                    <% if (!c.notified) { %>
                        <button class="btn" onclick="notifyOfficer('<%= c.id %>')">Notify Officer</button>
                    <% } else { %>
                        <span>Notified at: <%= c.notifiedAt ? new Date(Number(c.notifiedAt)).toLocaleString() : '—' %></span>
                    <% } %>
                    <% if (!c.resolvedByAdmin) { %>
                        <button class="btn" onclick="markAdminResolved('<%= c.id %>')">Mark Resolved</button>
                    <% } %>
                </div>
            </div>
            <% }); %>
        <% } else { %>
            <p>No active complaints.</p>
        <% } %>
    </div>

    <div class="card">
        <h3>Resolved Complaints</h3>
        <% if (resolvedComplaints && resolvedComplaints.length > 0) { %>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 0.5rem;">Complaint ID</th>
                        <th style="border: 1px solid #ddd; padding: 0.5rem;">Request ID</th>
                        <th style="border: 1px solid #ddd; padding: 0.5rem;">Client</th>
                        <th style="border: 1px solid #ddd; padding: 0.5rem;">Officer</th>
                        <th style="border: 1px solid #ddd; padding: 0.5rem;">Resolved At</th>
                    </tr>
                </thead>
                <tbody>
                    <% resolvedComplaints.forEach(rc => { %>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 0.5rem;"><%= rc.id %></td>
                            <td style="border: 1px solid #ddd; padding: 0.5rem;"><%= rc.requestId %></td>
                            <td style="border: 1px solid #ddd; padding: 0.5rem;"><%= rc.clientUserId %></td>
                            <td style="border: 1px solid #ddd; padding: 0.5rem;"><%= rc.officerUserId %></td>
                            <td style="border: 1px solid #ddd; padding: 0.5rem;"><%= rc.resolvedAt ? new Date(Number(rc.resolvedAt)).toLocaleString() : '—' %></td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } else { %>
            <p>No resolved complaints.</p>
        <% } %>
    </div>
    
    <script>
        async function assignRequest(requestId) {
            const form = document.getElementById('assignForm-' + requestId);
            const formData = new FormData(form);
            
            try {
                const response = await fetch('/admin/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requestId: formData.get('requestId'),
                        officerUserId: formData.get('officerUserId')
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Request assigned successfully! TX: ' + result.tx);
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function notifyOfficer(complaintId) {
            const res = await fetch('/admin/complaints/notify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ complaintId })
            });
            const result = await res.json();
            if (result.success) {
                alert('Officer notified');
                location.reload();
            } else {
                alert('Error: ' + (result.error || 'Failed'));
            }
        }

        async function markAdminResolved(complaintId) {
            const res = await fetch('/admin/complaints/mark-resolved', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ complaintId })
            });
            const result = await res.json();
            if (result.success) {
                alert('Marked resolved');
                location.reload();
            } else {
                alert('Error: ' + (result.error || 'Failed'));
            }
        }
    </script>
<%- include('../../partials/footer') %>